* GENERATED BY CHARMM-GUI (http://www.charmm-gui.org) v3.7 on Mar, 24. 2022. JOBID=4814588605
* Orient nanotube's principal axis along user's chosen PBC dimension or X
*

DIMENS CHSIZE 5000000 MAXRES 5000000 MAXGRP 5000000

! Read topology and parameter files
stream toppar.str

stream step1.1_user_input.str

ioformat ext
read rtf card name @{prefix}.rtf append flex

!
! user input
!
set xpbc = no
set ypbc = no
set zpbc = no
if pbc .eq. x   set   xpbc = yes
if pbc .eq. y   set   ypbc = yes
if pbc .eq. z   set   zpbc = yes

set impatch = yes
if pbc .eq. no set impatch = no

read sequence tube 1
generate NM first none last none

open read unit 10 card name @{prefix}.crd
read coor unit 10 card


set XTLtype = ORTHORHOMBIC
set alpha = 90
set beta  = 90
set gamma = 90
coor stat sele all end
calc A = ?xmax - ?xmin
calc B = ?ymax - ?ymin
calc C = ?zmax - ?zmin
if zpbc .eq. yes calc C = @C + 1.2
coor trans xdir -?xave ydir -?yave zdir -?zave

!image patch
if impatch .eq. yes then
    ! Setup PBC (Periodic Boundary Condition)
    crystal define @XTLtype  @A  @B  @C @{alpha} @{beta} @{gamma}

    open unit 10 read card name crystal_image.str
    crystal read unit 10 card

    open read unit 10 card name cubic.img
    read imag unit 10

    print images tran
    update imall
    define cartot sele .not. hydrogen end
    calc ncartot = ?nsel
    calc icar = 1
    label do_imp
        define bnc sele type C* .and. .bonded. ( cartot .subset. @icar )  end ! bond number
        if ?nsel .ne. 3 then
            coor stat sele cartot .subset. @icar end ! bond number
            if ?zave .lt. 0 then
                set cname = ?seltype
                impatch P@{cname} PRIME NM 1 C NM 1
            endif
        endif
        incr icar by 1
    if icar .le. @ncartot goto do_imp
    if xpbc .eq. yes then
        coor rotate ydir 1.0 phi 90
    endif
    if ypbc .eq. yes then
        coor rotate xdir 1.0 phi 90
    endif

    open write card unit 10 name image.psf
    write image psf unit 10
    close unit 10

endif

coor stat sele all end
calc boxx = ?xmax - ?xmin
calc boxy = ?ymax - ?ymin
calc boxz = ?zmax - ?zmin

!
! write step1 information
!

! Replace these lines with auto-generated names
open write card unit 10 name step1_nanomaterial.psf
write psf unit 10 card
if impatch .eq. yes then
    system "python genimpsf_v2.py step1_nanomaterial.psf"
endif

open write card unit 10 name step1_nanomaterial.crd
write coor unit 10 card

open write card unit 10 name step1_nanomaterial.pdb
write coor unit 10 pdb

open write unit 90 card name step1_nanomaterial.str

write title unit 90
* set ncharge = ?cgtot
* set xmax = ?xmax
* set ymax = ?ymax
* set zmax = ?zmax
* set xmin = ?xmin
* set ymin = ?ymin
* set zmin = ?zmin
* set xcen = ?xave
* set ycen = ?yave
* set zcen = ?zave
* set boxx = @{boxx}
* set boxy = @{boxy}
* set boxz = @{boxz}
* set alpha = @alpha
* set beta  = @beta
* set gamma = @gamma
* set impatch = @impatch
* set boxtype = rect
* set xtltype = orthorhombic
*


